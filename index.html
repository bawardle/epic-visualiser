<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Estimation Visualiser</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #343434, #4B0082); color: #f0f0f0; }
        #app { position: relative; width: 100%; min-height: 100vh; overflow: auto; }
                .work-item-card { position: absolute; cursor: grab; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-radius: 9999px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: black; animation: border-pulse 2s infinite, wobble 4.375s infinite alternate; }
        .work-item-card.default-glow { animation: border-pulse 2s infinite, wobble 4.375s infinite alternate; }
        .work-item-card.active-glow { animation: blue-pulse 2s infinite, wobble 4.375s infinite alternate; }
        .work-item-card.closed-glow { animation: green-pulse 2s infinite, wobble 4.375s infinite alternate; }
        .epic-card { width: 300px; height: 300px; background-color: #ffedd5; border: 12px solid #fb923c; }
        .feature-card { width: 200px; height: 200px; background-color: #e9d5ff; border: 8px solid #a855f7; }
        @keyframes border-pulse {
            0% { box-shadow: 0 0 0 0 currentColor; }
            50% { box-shadow: 0 0 0 11px rgba(0, 0, 0, 0.2); }
            100% { box-shadow: 0 0 0 0 currentColor; }
        }
        @keyframes blue-pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        @keyframes green-pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        @keyframes wobble {
            0% { transform: translate(0px, 0px); }
            25% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, 2px); }
            75% { transform: translate(2px, -2px); }
            100% { transform: translate(-2px, -2px); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div style="position: absolute; top: 0; left: 0; right: 0; background-color: #16131D; height: 200px; border-bottom: 8px solid #D3D3D3; z-index: 0;"></div>
        <div style="position: absolute; top: 1rem; left: 1rem; z-index: 10;">
            <h1 style="font-size: 1.875rem; font-weight: bold; color: white;">Epic Estimation Visualiser</h1>
            <p style="color: #9ca3af;">Enter an Epic ID to visualise the hierarchy.</p>
            <div style="margin-top: 1rem;">
                <input type="text" id="epicIdInput" style="background-color: #1f2937; color: white; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.5rem; width: 24rem;" placeholder="e.g. 4440244">
            </div>
            <p id="loading" style="color: #facc15; margin-top: 0.5rem; display: none;">Loading...</p>
            <p id="error" style="color: #ef4444; margin-top: 0.5rem;"></p>
        </div>
        <div style="position: absolute; z-index: 10; top: 96px; left: 520px;">
            <button id="visualiseButton" style="background-color: black; color: white; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid white;">Visualise Epic</button>
        </div>
        <div style="position: absolute; z-index: 10; top: 141px; left: 520px;">
            <button id="resetButton" style="background-color: black; color: white; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid white;">Reset Positions</button>
        </div>
        <div style="position: absolute; z-index: 10; top: 141px; left: 680px;">
            <button id="clearButton" style="background-color: black; color: white; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid white;">Clear</button>
        </div>
        <div id="visualization-slate" style="position: absolute; background-color: #4F4F4F; z-index: -2; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5), 0 4px 8px rgba(0, 0, 0, 0.3); border: 1px solid #3A3A3A; background-image: linear-gradient(to right, rgba(200, 200, 200, 0.1) 1px, transparent 1px), linear-gradient(to bottom, rgba(200, 200, 200, 0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
        <svg id="svgCanvas" style="position: absolute; top: 0; left: 0; z-index: -1;"></svg>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = document.getElementById('app');
            const epicIdInput = document.getElementById('epicIdInput');
            const visualiseButton = document.getElementById('visualiseButton');
            const resetButton = document.getElementById('resetButton');
            const clearButton = document.getElementById('clearButton');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const svgCanvas = document.getElementById('svgCanvas');

            let allWorkItems = [];
            let originalPositions = new Map();
            let draggedItem = null;
            let offsetX = 0;
            let offsetY = 0;

            const getMaxWeeksFromTShirtSize = (tshirtSize) => {
                if (!tshirtSize) return null;
                const matches = tshirtSize.match(/\((\d+)-(\d+) weeks\)|< (\d+) weeks/);
                if (matches) {
                    if (matches[3]) { // X Small (< 4 weeks)
                        return parseInt(matches[3]);
                    } else if (matches[2]) { // Small (4-8 weeks), Medium (9-16 weeks), Large (17-26 weeks)
                        return parseInt(matches[2]);
                    }
                }
                return null;
            };

            const getCardSize = (type) => type === 'Epic' ? 300 : 200;

            const fetchEpicHierarchy = async () => {
                if (!epicIdInput.value) return;
                loading.style.display = 'block';
                error.textContent = '';

                try {
                    const response = await fetch('http://localhost:3000/api/epichierarchy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ epicId: epicIdInput.value })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const hierarchy = await response.json();
                    layoutHierarchy(hierarchy);
                } catch (err) {
                    error.textContent = 'Failed to fetch epic hierarchy.';
                    console.error('Fetch error:', err);
                } finally {
                    loading.style.display = 'none';
                }
            };

            const flattenHierarchy = (node) => {
                if (!node) return [];
                const list = [{...node, children: node.children ? node.children.map(c => c.Id) : []}];
                if (node.children) {
                    for (const child of node.children) {
                        list.push(...flattenHierarchy(child));
                    }
                }
                return list;
            };

            const layoutHierarchy = (hierarchy) => {
                clearVisualization();
                allWorkItems = flattenHierarchy(hierarchy);

                allWorkItems.forEach(item => {
                    item.wobbleDelay = Math.random() * -4.375; // Use negative delay for random start
                });

                const itemsById = new Map(allWorkItems.map(item => [item.Id, item]));

                const epic = itemsById.get(hierarchy.Id);
                const features = hierarchy.children || [];

                const centerX = window.innerWidth / 2;
                const centerY = 678;

                epic.x = centerX - 150;
                epic.y = centerY - 150;

                const featureOrbitRadius = 350;
                features.forEach((featureNode, index) => {
                    const feature = itemsById.get(featureNode.Id);
                    const angle = (2 * Math.PI / features.length) * index;
                    feature.x = epic.x + 150 - 100 + featureOrbitRadius * Math.cos(angle);
                    feature.y = epic.y + 150 - 100 + featureOrbitRadius * Math.sin(angle);
                });

                renderWorkItems();
                updateLines();
                saveOriginalPositions();
            };

            const renderWorkItems = () => {
                allWorkItems.forEach(item => {
                    const card = document.createElement('div');
                    card.id = `card-${item.Id}`;
                    
                    const typeClass = `${item.WorkItemType.toLowerCase()}-card`;
                    const glowClass = item.State === 'Active' ? 'active-glow' : 'default-glow';
                    card.className = `work-item-card ${typeClass} ${glowClass}`;

                    card.style.left = `${item.x}px`;
                    card.style.top = `${item.y}px`;
                    card.style.animationDelay = `${item.wobbleDelay}s`; // Apply the random delay

                    card.innerHTML = `
                        <div style="font-size: 0.875rem; ${item.WorkItemType === 'Feature' ? 'padding: 10px;' : ''} display: flex; flex-direction: column; justify-content: center; flex-grow: 1; line-height: 1.2;">
                            <div style="font-weight: bold; font-size: ${item.WorkItemType === 'Epic' ? '1.25rem' : '1.1rem'}; text-align: center;">${item.Id}</div>
                            <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; margin: 0; padding: 0;">${item.Name.substring(0, 20)}...</p>
                            ${item.WorkItemType === 'Feature' && item.Effort > 0 ? `<p style="text-align: center; margin: 0; padding: 0;"><strong>Effort:</strong> ${item.Effort}</p>` : ''}
                            <p style="text-align: center; margin: 0; padding: 0;">${item.State || 'N/A'}</p>
                            <p style="text-align: center; margin: 0; padding: 0;">${item.TShirtSize || 'N/A'}</p>
                            ${item.WorkItemType === 'Epic' && item.Effort > 0 ? `<p style="text-align: center; margin: 0; padding: 0;"><strong>Epic Effort:</strong> ${item.Effort}</p>` : ''}
                        </div>
                    `;

                    card.addEventListener('mousedown', (e) => startDrag(e, item));
                    app.appendChild(card);
                });
            };

            const updateLines = () => {
                svgCanvas.innerHTML = '';
                let minX = Infinity;
                let minY = Infinity;
                let maxX = -Infinity;
                let maxY = -Infinity;

                allWorkItems.forEach(item => {
                    const itemSize = getCardSize(item.WorkItemType);
                    minX = Math.min(minX, item.x);
                    minY = Math.min(minY, item.y);
                    maxX = Math.max(maxX, item.x + itemSize);
                    maxY = Math.max(maxY, item.y + itemSize);
                });

                const padding = 50; // Padding around the visualization

                // Adjust SVG and slate position and size
                const vizWidth = (maxX - minX) + (2 * padding);
                const vizHeight = (maxY - minY) + (2 * padding);

                svgCanvas.setAttribute('width', vizWidth);
                svgCanvas.setAttribute('height', vizHeight);
                svgCanvas.style.left = `${minX - padding}px`;
                svgCanvas.style.top = `${minY - padding}px`;

                const slate = document.getElementById('visualization-slate');
                if (slate) {
                    slate.style.left = `${minX - padding}px`;
                    slate.style.top = `${minY - padding}px`;
                    slate.style.width = `${vizWidth}px`;
                    slate.style.height = `${vizHeight}px`;
                }

                allWorkItems.forEach(parent => {
                    if (parent.children && parent.children.length > 0) {
                        const parentSize = getCardSize(parent.WorkItemType) / 2;

                        parent.children.forEach(childId => {
                            const child = allWorkItems.find(i => i.Id === childId);
                            if (child) {
                                const childSize = getCardSize(child.WorkItemType) / 2;

                                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                                line.setAttribute('x1', (parent.x + parentSize) - minX + padding);
                                line.setAttribute('y1', (parent.y + parentSize) - minY + padding);
                                line.setAttribute('x2', (child.x + childSize) - minX + padding);
                                line.setAttribute('y2', (child.y + childSize) - minY + padding);
                                line.setAttribute('stroke-width', '6');

                                const epicMaxWeeks = getMaxWeeksFromTShirtSize(parent.TShirtSize);
                                const featureMaxWeeks = getMaxWeeksFromTShirtSize(child.TShirtSize);

                                if (epicMaxWeeks !== null && featureMaxWeeks !== null && featureMaxWeeks < epicMaxWeeks) {
                                    line.setAttribute('stroke', '#ffffff'); // Revert to white
                                } else if (epicMaxWeeks !== null && featureMaxWeeks !== null && featureMaxWeeks > epicMaxWeeks) {
                                    line.setAttribute('stroke', '#F44336'); // Modern red
                                } else {
                                    line.setAttribute('stroke', '#ffffff');
                                }
                                svgCanvas.appendChild(line);
                            }
                        });
                    }
                });
            };

            const saveOriginalPositions = () => {
                originalPositions.clear();
                allWorkItems.forEach(item => {
                    originalPositions.set(item.Id, { x: item.x, y: item.y });
                });
            };

            const resetPositions = () => {
                allWorkItems.forEach(item => {
                    const originalPos = originalPositions.get(item.Id);
                    if (originalPos) {
                        item.x = originalPos.x;
                        item.y = originalPos.y;
                        const card = document.getElementById(`card-${item.Id}`);
                        if (card) {
                            card.style.left = `${item.x}px`;
                            card.style.top = `${item.y}px`;
                        }
                    }
                });
                updateLines();
            };

            const clearVisualization = () => {
                allWorkItems = [];
                originalPositions.clear();
                app.querySelectorAll('.work-item-card').forEach(el => el.remove());
                svgCanvas.innerHTML = '';
                epicIdInput.value = '';
                error.textContent = '';
            };

            const startDrag = (e, item) => {
                draggedItem = item;
                const card = document.getElementById(`card-${item.Id}`);
                const rect = card.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                document.addEventListener('mousemove', doDrag);
                document.addEventListener('mouseup', stopDrag);
            };

            const doDrag = (e) => {
                if (!draggedItem) return;
                draggedItem.x = e.clientX - offsetX;
                draggedItem.y = e.clientY - offsetY;
                const card = document.getElementById(`card-${draggedItem.Id}`);
                card.style.left = `${draggedItem.x}px`;
                card.style.top = `${draggedItem.y}px`;
                updateLines();
            };

            const stopDrag = () => {
                draggedItem = null;
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);
            };

            visualiseButton.addEventListener('click', fetchEpicHierarchy);
            resetButton.addEventListener('click', resetPositions);
            clearButton.addEventListener('click', clearVisualization);
        });
    </script>
</body>
</html>