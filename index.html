<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADO Explorer</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #343434, #4B0082); color: #f0f0f0; }
        #app { position: relative; width: 100%; min-height: 200vh; overflow: auto; }
                .work-item-card { position: absolute; cursor: grab; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-radius: 9999px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: black; animation: border-pulse 2s infinite; }
        .work-item-card.default-glow { animation: border-pulse 2s infinite; }
        .work-item-card.active-glow { animation: blue-pulse 2s infinite; }
        .work-item-card.closed-glow { animation: green-pulse 2s infinite; }
        .epic-card { width: 300px; height: 300px; background-color: #ffedd5; border: 12px solid #fb923c; }
        .feature-card { width: 200px; height: 200px; background-color: #e9d5ff; border: 8px solid #a855f7; }
        .initiative-card { width: 350px; height: 350px; background-color: #d1fae5; border: 12px solid #10b981; }
        .user-story-card { width: 100px; height: 100px; background-color: #e0f2fe; border: 4px solid #0ea5e9; }
        .task-card { width: 80px; height: 80px; background-color: #fffacd; border: 4px solid #daa520; }
        @keyframes border-pulse {
            0% { box-shadow: 0 0 0 0 currentColor; }
            50% { box-shadow: 0 0 0 11px rgba(0, 0, 0, 0.2); }
            100% { box-shadow: 0 0 0 0 currentColor; }
        }
        @keyframes blue-pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        @keyframes green-pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        @keyframes wobble {
            0% { transform: translate(0px, 0px); }
            25% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, 2px); }
            75% { transform: translate(2px, -2px); }
            100% { transform: translate(-2px, -2px); }
        }
        @keyframes flash-red {
            0% { stroke: #F44336; opacity: 1; }
            50% { stroke: #F44336; opacity: 0.5; }
            100% { stroke: #F44336; opacity: 1; }
        }
        
        .fade-transition {
            transition: opacity 0.5s ease-in-out;
        }
        .work-item-card.removed-glow {
            filter: grayscale(100%);
            animation: border-pulse 2s infinite;
        }
    /* Starry background */
    #stars-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Allow clicks to pass through */
        z-index: -2; /* Behind everything else */
    }

    .star {
        position: absolute;
        background: radial-gradient(circle at center, rgba(255, 255, 255, 1.0) 0%, rgba(255, 255, 255, 0) 70%);
        border-radius: 50%;
        animation: twinkle 5s infinite ease-in-out alternate;
    }

    @keyframes twinkle {
        0% { opacity: 0; transform: scale(0.5); }
        50% { opacity: 1.0; transform: scale(1); }
        100% { opacity: 0; transform: scale(0.5); }
    }

    .spinner {
        border: 8px solid #f3f3f3; /* Light grey */
        border-top: 8px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>
</head>
<body>
    <script>
        // This will be replaced by Azure Static Web Apps during deployment
        // For local development, you can set it here or via a local server setup
        window.API_URL = ''; // Default to empty string for relative paths or set your local API URL
    </script>
    <div id="stars-container"></div>
    <div id="app">
        
        <div id="ui-controls">
            <div style="position: absolute; top: 1rem; left: 1rem; z-index: 10;">
                <h1 style="font-size: 1.875rem; font-weight: bold; color: white;">ADO Explorer</h1>
                <p style="color: #9ca3af;">Enter an Initiative ID to visualise the hierarchy.</p>
                <div style="margin-top: 1rem;">
                    <input type="text" id="epicIdInput" style="background-color: #1f2937; color: white; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.5rem; width: 24rem;" placeholder="E.g. 4000674...">
                </div>
                <div id="loading-container" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); flex-direction: column; align-items: center; justify-content: center;">
                    <div class="spinner"></div>
                    <span id="loading-text" style="color: #facc15; margin-top: 1rem;">Loading Initiative Heirarchy...</span>
                </div>
                <p id="error" style="color: #ef4444; margin-top: 0.5rem;"></p>
            </div>
            <div style="position: absolute; z-index: 10; top: 60px; left: 520px;">
                <button id="visualiseButton" style="background-color: #222222; color: #bbbbbb; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #555555;">Display Initiative</button>
            </div>
            <div style="position: absolute; z-index: 10; top: 70px; left: 680px; display: flex; align-items: center;">
                <input type="checkbox" id="enableDraggingCheckbox" style="margin-right: 0.5rem;">
                <label for="enableDraggingCheckbox" style="color: #bbbbbb;">Enable Dragging</label>
            </div>
            <div style="position: absolute; z-index: 10; top: 90px; left: 680px; display: flex; align-items: center;">
                <input type="checkbox" id="disableAudioCheckbox" style="margin-right: 0.5rem;">
                <label for="disableAudioCheckbox" style="color: #bbbbbb;">Disable Audio</label>
            </div>
            <div style="position: absolute; z-index: 10; top: 110px; left: 680px; display: flex; align-items: center;">
                <label for="developerWeekAsStoryPoints" style="color: #bbbbbb; margin-right: 0.5rem;">Developer Week as Story Points:</label>
                <input type="number" id="developerWeekAsStoryPoints" placeholder="default override 8" style="background-color: #1f2937; color: white; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.25rem; width: 8rem;">
            </div>
            <div style="position: absolute; z-index: 10; top: 110px; left: 520px;">
                <button id="resetButton" style="background-color: #222222; color: #bbbbbb; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #555555;">Reset Positions</button>
            </div>
            <div style="position: absolute; z-index: 10; top: 160px; left: 520px;">
                <button id="clearButton" style="background-color: #222222; color: #bbbbbb; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #555555;">Clear</button>
            </div>
            <div style="position: absolute; z-index: 10; top: 160px; left: 620px;">
                <button id="exportCsvButton" style="background-color: #222222; color: #bbbbbb; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #555555;">Export to CSV</button>
                <button id="targetDateCalculatorBtn" style="background-color: #222222; color: #bbbbbb; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #555555; margin-left: 10px;">Target Date Calculator</button>
            </div>
        </div>
        <div style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
            <button id="hideUiButton" style="background-color: #222222; color: #bbbbbb; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #555555;">Hide UI</button>
        </div>
        <svg id="svgCanvas" style="position: absolute; top: 0; left: 0; z-index: -1;"></svg>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = document.getElementById('app');
            const epicIdInput = document.getElementById('epicIdInput');
            const bubbleSound = new Audio('sounds/mixkit-bubble-pop-up-alert-notification-2357.wav'); // Load sound effect
            const visualiseButton = document.getElementById('visualiseButton');
            const resetButton = document.getElementById('resetButton');
            const clearButton = document.getElementById('clearButton');
            const loadingContainer = document.getElementById('loading-container');
            const error = document.getElementById('error');
            const svgCanvas = document.getElementById('svgCanvas');

            // New additions for dynamic loading text
            const loadingText = document.getElementById('loading-text');
            const loadingPhrases = [
                "Consulting the digital oracle...",
                "Aligning the cosmic data streams...",
                "Summoning the work item spirits...",
                "Unraveling the threads of hierarchy...",
                "Bending spacetime for faster data retrieval...",
                "Polishing pixels for your viewing pleasure...",
                "Negotiating with the server gnomes...",
                "Warming up the visualization engine...",
                "Just a moment, the bits are dancing...",
                "Almost there, don't go anywhere!",
                "Loading Initiative Heirarchy..." // Keep this as a default/starting phrase
            ];
            let loadingInterval; // To store the interval ID

            // Adjust SVG canvas to match window size
            svgCanvas.style.width = '100%';
            svgCanvas.style.height = '100%';
            svgCanvas.style.left = '0px';
            svgCanvas.style.top = '0px';

            let allWorkItems = [];
            let originalPositions = new Map();
            let draggedItem = null;
            let offsetX = 0;
            let offsetY = 0;
            let startX = 0;
            let startY = 0;
            let isDragging = false;
            let currentlyRenderedItems = [];
            let currentView = 'epic';
            let isDraggingEnabled = false; // New variable for dragging state
            let isAudioDisabled = false;

            const enableDraggingCheckbox = document.getElementById('enableDraggingCheckbox');
            enableDraggingCheckbox.addEventListener('change', () => {
                isDraggingEnabled = enableDraggingCheckbox.checked;
                // Re-render items to apply drag/no-drag state
                renderWorkItems(currentlyRenderedItems);
            });

            const disableAudioCheckbox = document.getElementById('disableAudioCheckbox');
            const developerWeekAsStoryPointsInput = document.getElementById('developerWeekAsStoryPoints');
            disableAudioCheckbox.addEventListener('change', () => {
                isAudioDisabled = disableAudioCheckbox.checked;
            });

            const getMaxWeeksFromTShirtSize = (tshirtSize) => {
                if (!tshirtSize) return null;
                const matches = tshirtSize.match(/\((\d+)-(\d+) weeks\)|< (\d+) weeks/);
                if (matches) {
                    if (matches[3]) { // X Small (< 4 weeks)
                        return parseInt(matches[3]);
                    } else if (matches[2]) { // Small (4-8 weeks), Medium (9-16 weeks), Large (17-26 weeks)
                        return parseInt(matches[2]);
                    }
                }
                return null;
            };

            const getCardSize = (type) => {
                if (type === 'Epic') return 300;
                if (type === 'Feature') return 220;
                if (type === 'User Story') return 100;
                if (type === 'Task') return 80; // Added for Task
                if (type === 'Initiative') return 350;
                return 100;
            }

            const layoutFeatureView = async (featureId) => {
                console.log('--- Layout Feature View ---');
                console.log('Feature ID:', featureId);
                console.log('All work items:', allWorkItems);
                clearVisualization(false);
                if (!isAudioDisabled) {
                    bubbleSound.play(); // Play sound effect
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait for fade-out
                const itemsById = new Map(allWorkItems.map(item => [item.Id, item]));
                const feature = itemsById.get(featureId);
                console.log('Feature:', feature);
                if (!feature) {
                    console.error('Feature not found!');
                    return;
                }
                const userStories = feature.children.map(child => itemsById.get(child.Id));
                console.log('User stories:', userStories);

                const centerX = window.innerWidth / 2;
                const centerY = 678;

                const outerSize = 150; // User story size - Increased from 120
                const centerSize = Math.round(outerSize * 1.41); // Feature size - Recalculated

                feature.displaySize = centerSize;
                userStories.forEach(us => us.displaySize = outerSize);

                feature.x = centerX - centerSize / 2;
                feature.y = centerY - centerSize / 2;

                const userStoryOrbitRadius = 350;
                userStories.forEach((userStory, index) => {
                    const angle = (2 * Math.PI / userStories.length) * index;
                    userStory.x = feature.x + centerSize / 2 - outerSize / 2 + userStoryOrbitRadius * Math.cos(angle);
                    userStory.y = feature.y + centerSize / 2 - outerSize / 2 + userStoryOrbitRadius * Math.sin(angle);
                });

                const itemsToRender = [feature, ...userStories];
                currentlyRenderedItems = itemsToRender;
                renderWorkItems(itemsToRender);
                updateLines(itemsToRender);
                currentView = 'feature';
                currentFeatureHierarchy = feature; // Store this Feature hierarchy
            };

            const layoutUserStoryView = async (userStoryId) => {
                console.log('--- Layout User Story View ---');
                console.log('User Story ID:', userStoryId);
                console.log('All work items:', allWorkItems);
                clearVisualization(false);
                if (!isAudioDisabled) {
                    bubbleSound.play(); // Play sound effect
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait for fade-out
                const itemsById = new Map(allWorkItems.map(item => [item.Id, item]));
                const userStory = itemsById.get(userStoryId);
                console.log('User Story:', userStory);
                if (!userStory) {
                    console.error('User Story not found!');
                    return;
                }
                const tasks = userStory.children.map(child => itemsById.get(child.Id));
                console.log('Tasks:', tasks);

                const centerX = window.innerWidth / 2;
                const centerY = 678;

                const outerSize = 80; // Task size
                const centerSize = Math.round(outerSize * 1.41); // User Story size - Recalculated

                userStory.displaySize = centerSize;
                tasks.forEach(task => task.displaySize = outerSize);

                userStory.x = centerX - centerSize / 2;
                userStory.y = centerY - centerSize / 2;

                const taskOrbitRadius = 200; // Smaller radius for tasks
                tasks.forEach((task, index) => {
                    const angle = (2 * Math.PI / tasks.length) * index;
                    task.x = userStory.x + centerSize / 2 - outerSize / 2 + taskOrbitRadius * Math.cos(angle);
                    task.y = userStory.y + centerSize / 2 - outerSize / 2 + taskOrbitRadius * Math.sin(angle);
                });

                const itemsToRender = [userStory, ...tasks];
                currentlyRenderedItems = itemsToRender;
                renderWorkItems(itemsToRender);
                updateLines(itemsToRender);
                currentView = 'userstory';
            };

            let originalHierarchy = null;
            let currentEpicHierarchy = null;
            let currentFeatureHierarchy = null; // Added for User Story to Feature zoom out

            const fetchHierarchy = async () => {
                if (!epicIdInput.value) return;
                loadingContainer.style.display = 'flex';
                error.textContent = '';
                startLoadingTextAnimation(); // Start the animation

                try {
                    const response = await fetch(`https://adoexplorerfunctionapp.azurewebsites.net/api/initiativehierarchy?`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initiativeId: epicIdInput.value })
                    });

                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData && errorData.error) {
                                errorMessage = errorData.error;
                            }
                        } catch (e) {
                            // The error response was not valid JSON. Use the default message.
                        }
                        throw new Error(errorMessage);
                    }

                    const hierarchy = await response.json();
                    originalHierarchy = hierarchy;
                    console.log('Received hierarchy:', hierarchy);
                    layoutHierarchy(hierarchy);
                } catch (err) {
                    error.textContent = err.message;
                    console.error('Fetch error:', err);
                } finally {
                    loadingContainer.style.display = 'none';
                    stopLoadingTextAnimation(); // Stop the animation
                }
            };

            const flattenHierarchy = (node) => {
                if (!node) return [];
                const list = [node];
                if (node.children) {
                    for (const child of node.children) {
                        list.push(...flattenHierarchy(child));
                    }
                }
                return list;
            };

            const layoutHierarchy = async (hierarchy) => {
                clearVisualization(false);
                if (!isAudioDisabled) {
                    bubbleSound.play(); // Play sound effect
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait for fade-out
                allWorkItems = flattenHierarchy(hierarchy);

                allWorkItems.forEach(item => {
                    item.wobbleDelay = Math.random() * -4.375; // Use negative delay for random start
                });

                const itemsById = new Map(allWorkItems.map(item => [item.Id, item]));

                // Calculate total story points and estimated effort for all work items
                // Iterate in reverse to ensure children's story points are calculated first
                for (let i = allWorkItems.length - 1; i >= 0; i--) {
                    const item = allWorkItems[i];
                    if (item.children && item.children.length > 0) {
                        item.totalStoryPoints = item.children.reduce((total, child) => {
                            const childItem = itemsById.get(child.Id);
                            return total + (childItem && childItem.totalStoryPoints ? childItem.totalStoryPoints : (childItem && childItem.StoryPoints ? childItem.StoryPoints : 0));
                        }, 0);
                    } else {
                        // If no children, totalStoryPoints is just its own StoryPoints
                        item.totalStoryPoints = item.StoryPoints || 0;
                    }

                    // Calculate Effort for Epics, Initiatives, and Features
                    if (item.WorkItemType === 'Epic' || item.WorkItemType === 'Initiative' || item.WorkItemType === 'Feature') {
                        const developerWeekAsStoryPoints = parseFloat(developerWeekAsStoryPointsInput.value) || 8;
                        item.Effort = Math.round(item.totalStoryPoints / developerWeekAsStoryPoints);
                    }
                }

                const centerX = window.innerWidth / 2;
                const centerY = 678;

                // Position the central item (Initiative or Epic)
                let centralItem;
                let orbitingItems = [];
                let orbitRadius;

                if (hierarchy.WorkItemType === 'Initiative') {
                    centralItem = itemsById.get(hierarchy.Id);
                    orbitingItems = (hierarchy.children || []).map(child => itemsById.get(child.Id));
                    orbitRadius = 375; // Orbit radius for Epics around Initiative

                    const outerSize = 210;
                    const centerSize = Math.round(outerSize * 1.41);

                    centralItem.displaySize = centerSize;
                    orbitingItems.forEach(epic => epic.displaySize = outerSize);

                    centralItem.x = centerX - centerSize / 2;
                    centralItem.y = centerY - centerSize / 2;

                } else if (hierarchy.WorkItemType === 'Epic') {
                    centralItem = itemsById.get(hierarchy.Id);
                    orbitingItems = (hierarchy.children || []).map(child => itemsById.get(child.Id));
                    orbitRadius = 350; // Orbit radius for Features around Epic

                    const outerSize = 180;
                    const centerSize = Math.round(outerSize * 1.41);

                    centralItem.displaySize = centerSize;
                    orbitingItems.forEach(feature => feature.displaySize = outerSize);

                    centralItem.x = centerX - centerSize / 2;
                    centralItem.y = centerY - centerSize / 2;
                    currentEpicHierarchy = hierarchy; // Store this Epic hierarchy
                }

                // Position orbiting items
                orbitingItems.forEach((itemNode, index) => {
                    const item = itemsById.get(itemNode.Id);
                    const angle = (2 * Math.PI / orbitingItems.length) * index;
                    const centralItemSize = centralItem.displaySize;
                    const orbitingItemSize = item.displaySize;

                    item.x = centralItem.x + centralItemSize / 2 - orbitingItemSize / 2 + orbitRadius * Math.cos(angle);
                    item.y = centralItem.y + centralItemSize / 2 - orbitingItemSize / 2 + orbitRadius * Math.sin(angle);
                });

                currentlyRenderedItems = [centralItem, ...orbitingItems.map(f => itemsById.get(f.Id))];
                renderWorkItems(currentlyRenderedItems);
                updateLines(currentlyRenderedItems);
                saveOriginalPositions();
                currentView = hierarchy.WorkItemType.toLowerCase();
            };

            const renderWorkItems = (itemsToRender) => {
                itemsToRender.forEach(item => {
                    const card = document.createElement('div');
                    card.id = `card-${item.Id}`;
                    
                    const typeClass = `${item.WorkItemType.toLowerCase().replace(' ', '-')}-card`;
                    let glowClass = 'default-glow'; // Default to black glow for New, Inactive, and others
                    if (item.State === 'Active') {
                        glowClass = 'active-glow'; // Blue glow
                    } else if (item.State === 'Closed' || item.State === 'Completed') {
                        glowClass = 'closed-glow'; // Green glow
                    }

                    let additionalClasses = '';
                    if (item.State === 'Removed') {
                        additionalClasses += ' removed-glow'; // Add grayscale filter for removed items
                    }
                    card.className = `work-item-card ${typeClass} ${glowClass}${additionalClasses} fade-transition`;
                    if (item.State === 'Removed') {
                        card.style.backgroundColor = '#cccccc';
                        card.style.borderColor = '#999999';
                    }
                    card.style.opacity = '0'; // Start invisible for fade-in

                    card.style.left = `${item.x}px`;
                    card.style.top = `${item.y}px`;
                    card.style.width = `${item.displaySize || getCardSize(item.WorkItemType)}px`;
                    card.style.height = `${item.displaySize || getCardSize(item.WorkItemType)}px`;
                    let baseAnimation = 'border-pulse 2s infinite'; // Default glow animation
                    if (glowClass.includes('active-glow')) {
                        baseAnimation = 'blue-pulse 2s infinite';
                    } else if (glowClass.includes('closed-glow')) {
                        baseAnimation = 'green-pulse 2s infinite';
                    }

                    // Apply base animation
                    card.style.animation = baseAnimation;

                    // Add wobble animation for child items
                    if (currentlyRenderedItems.length > 0 && item.Id !== currentlyRenderedItems[0].Id) {
                        card.style.animation += `, wobble 4.375s infinite alternate ${item.wobbleDelay}s`;
                    }

                    card.title = item.Name;
                    card.innerHTML = `
                        <div style="font-size: ${item.WorkItemType === 'Initiative' ? '1.408rem' : item.WorkItemType === 'Task' ? '0.7rem' : '0.875rem'}; ${item.WorkItemType === 'Feature' ? 'padding: 10px;' : ''} display: flex; flex-direction: column; justify-content: center; flex-grow: 1; line-height: 1.2;">
                            <div style="font-weight: bold; font-size: ${item.WorkItemType === 'Initiative' ? '1.768rem' : item.WorkItemType === 'Epic' ? '1.25rem' : item.WorkItemType === 'Task' ? '0.8rem' : '1.1rem'}; text-align: center;">${item.Id}</div>
                            <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; margin: 0; padding: 0;">${item.WorkItemType === 'Task' ? item.Name.substring(0, 8) : item.Name.substring(0, 15)}...</p>
                            ${item.WorkItemType === 'User Story' ? `<p style="text-align: center; margin: 0; padding: 0;"><strong>Estimate:</strong> ${item.StoryPoints || 0}</p><p style="text-align: center; margin: 0; padding: 0; font-size: 0.7rem;">${item.State === 'Ready For Development' ? 'Ready<br>For<br>Development' : item.State || 'N/A'}</p>` : ''}
                            
                            ${item.WorkItemType !== 'User Story' ? `<p style="text-align: center; margin: 0; padding: 0;">${item.State || 'N/A'}</p>` : ''}
                            ${item.WorkItemType === 'Epic' ? `<p style="text-align: center; margin: 0; padding: 0;">${item.TShirtSize || 'No Size Given'}</p>` : item.WorkItemType !== 'User Story' && item.WorkItemType !== 'Task' ? `<p style="text-align: center; margin: 0; padding: 0;">${item.TShirtSize || 'N/A'}</p>` : ''}
                            ${item.WorkItemType === 'Feature' && item.Effort > 0 ? `<p style="text-align: center; margin: 0; padding: 0;">${item.Effort} Est. Approx. Weeks</p>` : ''}
                            ${item.WorkItemType === 'Feature' && item.totalStoryPoints > 0 ? `<p style="text-align: center; margin: 0; padding: 0;">${item.totalStoryPoints} Story Points</p>` : ''}
                            ${item.WorkItemType === 'Feature' && item.devCompletePercentage !== undefined ? `<p style="text-align: center; margin: 0; padding: 0;">${item.devCompletePercentage.toFixed(0)}% Dev Complete</p>` : ''}
                            ${(item.WorkItemType === 'Epic' || item.WorkItemType === 'Initiative') ? `<p style="text-align: center; margin: 0; padding: 0;">${item.Effort > 0 ? item.Effort : 'TBD'} Est. Approx. Weeks</p>` : ''}
                            ${item.WorkItemType === 'Epic' && item.devCompletePercentage !== undefined ? `<p style="text-align: center; margin: 0; padding: 0;">${item.devCompletePercentage.toFixed(0)}% Dev Complete</p>` : ''}
                            ${item.WorkItemType === 'Initiative' && item.devCompletePercentage !== undefined ? `<p style="text-align: center; margin: 0; padding: 0;">${item.devCompletePercentage.toFixed(0)}% Dev Complete</p>` : ''}
                        </div>
                    `;

                    if (item.WorkItemType !== 'Task') { // Tasks are not draggable
                        card.addEventListener('mousedown', (e) => startDrag(e, item));
                    }
                    app.appendChild(card);

                    // Trigger fade-in
                    setTimeout(() => {
                        card.style.opacity = '1';
                    }, 10); // Small delay to ensure CSS transition applies
                });
            };

            const updateLines = (itemsToRender) => {
                svgCanvas.style.opacity = '0'; // Start invisible for fade-in
                svgCanvas.innerHTML = '';

                // Use window dimensions for SVG
                svgCanvas.setAttribute('width', window.innerWidth);
                svgCanvas.setAttribute('height', window.innerHeight);
                svgCanvas.style.left = '0px';
                svgCanvas.style.top = '0px';
                svgCanvas.style.transition = 'opacity 0.5s ease-in-out';

                itemsToRender.forEach(parent => {
                    if (parent.children && parent.children.length > 0) {
                        const parentSize = (parent.displaySize || getCardSize(parent.WorkItemType)) / 2;

                        parent.children.forEach(child => {
                            const childItem = itemsToRender.find(i => i.Id === child.Id);
                            if (childItem) {
                                const childSize = (childItem.displaySize || getCardSize(childItem.WorkItemType)) / 2;

                                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                                line.setAttribute('x1', parent.x + parentSize);
                                line.setAttribute('y1', parent.y + parentSize);
                                line.setAttribute('x2', childItem.x + childSize);
                                line.setAttribute('y2', childItem.y + childSize);
                                line.setAttribute('stroke-width', '6');

                                const isFlashingRed = (parent.WorkItemType === 'Epic' && childItem.WorkItemType === 'Feature' && parseFloat(childItem.Effort) > parseFloat(parent.Effort));

                                if (isFlashingRed) {
                                    line.style.animation = 'flash-red 2s infinite alternate'; // Slow and subtle
                                    line.setAttribute('stroke', '#F44336'); // Set initial color
                                } else if (parent.Effort !== undefined && childItem.Effort !== undefined && parseFloat(childItem.Effort) < parseFloat(parent.Effort)) {
                                    line.setAttribute('stroke', '#ffffff'); // Revert to white
                                } else if (parent.Effort !== undefined && childItem.Effort !== undefined && parseFloat(childItem.Effort) > parseFloat(parent.Effort)) {
                                    line.setAttribute('stroke', '#F44336'); // Modern red
                                } else {
                                    line.setAttribute('stroke', '#ffffff');
                                }
                                svgCanvas.appendChild(line);
                            }
                        });
                    }
                });

                // Trigger fade-in
                setTimeout(() => {
                    svgCanvas.style.opacity = '1';
                }, 10); // Small delay to ensure CSS transition applies
            };

            const saveOriginalPositions = () => {
                originalPositions.clear();
                allWorkItems.forEach(item => {
                    originalPositions.set(item.Id, { x: item.x, y: item.y });
                });
            };

            const resetPositions = () => {
                allWorkItems.forEach(item => {
                    const originalPos = originalPositions.get(item.Id);
                    if (originalPos) {
                        item.x = originalPos.x;
                        item.y = originalPos.y;
                        const card = document.getElementById(`card-${item.Id}`);
                        if (card) {
                            card.style.left = `${item.x}px`;
                            card.style.top = `${item.y}px`;
                        }
                    }
                });
                updateLines(currentlyRenderedItems);
            };

            const clearVisualization = (fullClear = true) => {
                const cards = app.querySelectorAll('.work-item-card');
                cards.forEach(card => {
                    card.classList.add('fade-transition');
                    card.style.opacity = '0';
                });
                // No setTimeout here, make it synchronous
                cards.forEach(card => card.remove());
                svgCanvas.innerHTML = '';
                error.textContent = '';
                if (fullClear) {
                    allWorkItems = [];
                    originalHierarchy = null;
                    originalPositions.clear();
                    epicIdInput.value = '';
                }
            };

            const startLoadingTextAnimation = () => {
                let phraseIndex = 0;
                loadingText.textContent = loadingPhrases[phraseIndex]; // Set initial text
                loadingInterval = setInterval(() => {
                    phraseIndex = (phraseIndex + 1) % loadingPhrases.length;
                    loadingText.textContent = loadingPhrases[phraseIndex];
                }, 2000); // Change phrase every 2 seconds
            };

            const stopLoadingTextAnimation = () => {
                clearInterval(loadingInterval);
                loadingText.textContent = "Loading Initiative Heirarchy..."; // Reset to default
            };

            const DRAG_THRESHOLD = 5; // Pixels

            const startDrag = (e, item) => {
                draggedItem = item;
                isDragging = false; // Assume not dragging initially
                startX = e.clientX;
                startY = e.clientY;
                const card = document.getElementById(`card-${item.Id}`);
                const rect = card.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                document.addEventListener('mousemove', doDrag);
                document.addEventListener('mouseup', stopDrag);
            };

            const doDrag = (e) => {
                if (!draggedItem) return;

                // Check if movement exceeds threshold to consider it a drag
                if (Math.abs(e.clientX - startX) > DRAG_THRESHOLD || Math.abs(e.clientY - startY) > DRAG_THRESHOLD) {
                    isDragging = true;
                }

                if (isDragging && isDraggingEnabled) { // Only drag if dragging is enabled and threshold met
                    draggedItem.x = e.clientX - offsetX;
                    draggedItem.y = e.clientY - offsetY;
                    const card = document.getElementById(`card-${draggedItem.Id}`);
                    card.style.left = `${draggedItem.x}px`;
                    card.style.top = `${draggedItem.y}px`;
                    updateLines(currentlyRenderedItems);
                }
            };

            const stopDrag = async (e) => {
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);

                if (!isDragging && draggedItem) { // It was a click, not a drag
                    const clickedItem = draggedItem;

                    if (clickedItem.Id === currentlyRenderedItems[0].Id) {
                        // Clicked the central item (zoom out)
                        if (currentView === 'feature') {
                            currentlyRenderedItems.forEach(item => { delete item.displaySize; });
                            clearVisualization(false);
                            await layoutHierarchy(currentEpicHierarchy);
                        } else if (currentView === 'userstory') {
                            currentlyRenderedItems.forEach(item => { delete item.displaySize; });
                            clearVisualization(false);
                            await layoutFeatureView(currentFeatureHierarchy.Id);
                        } else if (currentView === 'epic') {
                            currentlyRenderedItems.forEach(item => { delete item.displaySize; });
                            clearVisualization(false);
                            await layoutHierarchy(originalHierarchy);
                        } else if (currentView === 'initiative') {
                            console.log('Already at Initiative level, cannot zoom out further.');
                        }
                    } else {
                        // Clicked an orbiting item (zoom in)
                        if (currentView === 'initiative' && clickedItem.WorkItemType === 'Epic') {
                            await layoutHierarchy(clickedItem);
                        } else if (currentView === 'epic' && clickedItem.WorkItemType === 'Feature') {
                            await layoutFeatureView(clickedItem.Id);
                        } else if (currentView === 'feature' && clickedItem.WorkItemType === 'User Story') {
                            await layoutUserStoryView(clickedItem.Id);
                        }
                    }
                }
                draggedItem = null;
                isDragging = false;
            };

            visualiseButton.addEventListener('click', fetchHierarchy);
            epicIdInput.addEventListener('keydown', (event) => {
                if (event.keyCode === 13) {
                    fetchHierarchy();
                }
            });
            resetButton.addEventListener('click', resetPositions);
            clearButton.addEventListener('click', clearVisualization);

            const hideUiButton = document.getElementById('hideUiButton');
            const uiControls = document.getElementById('ui-controls');

            hideUiButton.addEventListener('click', () => {
                if (uiControls.style.display === 'none') {
                    uiControls.style.display = 'block';
                    hideUiButton.textContent = 'Hide UI';
                } else {
                    uiControls.style.display = 'none';
                    hideUiButton.textContent = 'Show UI';
                }
            });

            const exportCsvButton = document.getElementById('exportCsvButton');
            exportCsvButton.addEventListener('click', exportToCSV);

            function exportToCSV() {
                if (allWorkItems.length === 0) {
                    alert("No data to export.");
                    return;
                }

                const itemsToExport = allWorkItems.filter(item => item.WorkItemType !== 'Task');

                if (itemsToExport.length === 0) {
                    alert("No data to export (excluding tasks).");
                    return;
                }

                const headers = ['ID', 'Name', 'WorkItemType', 'State', 'ParentID', 'StoryPoints', 'TShirtSize', 'Effort', 'DevCompletePercentage', 'TotalStoryPoints'];
                const csvRows = [headers.join(',')];

                itemsToExport.forEach(item => {
                    let parentId = '';
                    for (const parent of itemsToExport) {
                        if (parent.children && parent.children.some(child => child.Id === item.Id)) {
                            parentId = parent.Id;
                            break;
                        }
                    }

                    const row = [
                        item.Id,
                        `"${item.Name.replace(/"/g, '""')}"`,
                        item.WorkItemType,
                        item.State,
                        parentId,
                        item.StoryPoints || 0,
                        item.TShirtSize || '',
                        item.Effort || '',
                        item.devCompletePercentage !== undefined ? item.devCompletePercentage.toFixed(0) : '',
                        item.totalStoryPoints || 0
                    ];
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const initiativeId = document.getElementById('epicIdInput').value || 'NoInitiative';
                    const date = new Date();
                    const dateTimeString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}${date.getSeconds().toString().padStart(2, '0')}`;
                    const fileName = `AdoExplore_Output_${initiativeId}_${dateTimeString}.csv`;

                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        });
    </script>

    <div id="targetDateCalculatorModal" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
        <div style="background-color: #333; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; color: white;">
            <span id="closeModalBtn" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            <h2 style="color: white;">Target Date Calculator</h2>
            <div style="margin-bottom: 15px;">
                <label for="startedDate" style="display: block; margin-bottom: 5px;">Started Date:</label>
                <input type="date" id="startedDate" style="width: calc(100% - 12px); padding: 8px; border-radius: 5px; border: 1px solid #555; background-color: #444; color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="resourceAvailable" style="display: block; margin-bottom: 5px;">Resource Available (FTE):</label>
                <input type="number" id="resourceAvailable" value="1" min="1" style="width: calc(100% - 12px); padding: 8px; border-radius: 5px; border: 1px solid #555; background-color: #444; color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="storyPointEstimate" style="display: block; margin-bottom: 5px;">Story Point Estimate:</label>
                <input type="number" id="storyPointEstimate" value="0" min="0" style="width: calc(100% - 12px); padding: 8px; border-radius: 5px; border: 1px solid #555; background-color: #444; color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <button id="calculateTargetDate" style="background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">Calculate</button>
            </div>
            <div>
                <label for="estimatedTargetDate" style="display: block; margin-bottom: 5px;">Estimated Target Date:</label>
                <input type="text" id="estimatedTargetDate" readonly style="width: calc(100% - 12px); padding: 8px; border-radius: 5px; border: 1px solid #555; background-color: #444; color: white;">
                <p style="font-style: italic; font-size: 0.8em; color: #bbb; margin-top: 5px;">Note:- This is an approximate Date-only, Story Point conversion should not be used for exact date calculations.</p>
            </div>
        </div>
    </div>
    <script src="calculator.js"></script>
</body>
</html>